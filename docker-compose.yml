services:
    nuxt-app:
        build:
            context: .
            dockerfile: .docker/node/Dockerfile
            target: base # Use base stage for dev to mount volume
        command: sh -c "npm install && npm run dev"
        volumes:
            - .:/app
            - /app/node_modules
            - ./.logs/node:/app/.logs
        environment:
            - DB_HOST=db
            - DB_PORT=3306
            - DB_USER=${DB_USER}
            - DB_PASSWORD=${DB_PASSWORD}
            - DB_NAME=${DB_NAME}
        ports:
            - '3000:3000'
        depends_on:
            - db

    db:
        image: mariadb:latest
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_password}
            MYSQL_DATABASE: ${DB_NAME}
            MYSQL_USER: ${DB_USER}
            MYSQL_PASSWORD: ${DB_PASSWORD}
        ports:
            - '3306:3306'
        volumes:
            - db_data:/var/lib/mysql
            - ./.logs/mariadb:/var/log/mysql

    e2e:
        image: mcr.microsoft.com/playwright:v1.57.0-jammy
        ipc: host
        environment:
            - BASE_URL=http://nuxt-app:3000
            - CI=true
            - SKIP_WEBSERVER=true
        working_dir: /app
        volumes:
            - .:/app
            - /app/node_modules
        command: npx playwright test
        depends_on:
            - nuxt-app

volumes:
    db_data:
